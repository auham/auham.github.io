<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ø£Ø®Ø¨Ø§Ø± ÙˆÙ…Ø³ØªØ¬Ø¯Ø§Øª Ø¹Ø§Ø¦Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¨ÙŠØ·">
    <meta name="theme-color" content="#D4AF37">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ø§Ù„Ù…Ø±ÙŠØ¨ÙŠØ·">

    <title>Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…Ø±ÙŠØ¨ÙŠØ·</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="stylesheet" href="css/style.css">

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- OneSignal Push Notifications -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function (OneSignal) {
            await OneSignal.init({
                appId: "33461894-4470-4dd2-b2c3-222591f4ca88",
                safari_web_id: "web.onesignal.auto.33461894-4470-4dd2-b2c3-222591f4ca88"
            });
        });
    </script>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">Ù…</div>
            <div class="header-title">
                <h1>Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h1>
                <p>Ø¢Ø®Ø± Ø§Ù„Ù…Ø³ØªØ¬Ø¯Ø§Øª ÙˆØ§Ù„Ø£Ø®Ø¨Ø§Ø±</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- News Section -->
        <section class="section">
            <div class="section-title">
                <span class="icon">ğŸ“°</span>
                <h2>Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h2>
            </div>

            <div class="news-grid" id="newsGrid">
                <!-- Loading State -->
                <div class="loading" id="loadingState">
                    <div class="spinner"></div>
                </div>

                <!-- Empty State (hidden by default) -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="icon">ğŸ“°</div>
                    <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
                    <p>Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù‡Ù†Ø§</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="nav-container">
            <a href="index.html" class="nav-item">
                <span class="icon">ğŸ’</span>
                <span>Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</span>
            </a>
            <a href="news.html" class="nav-item active">
                <span class="icon">ğŸ“°</span>
                <span>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</span>
            </a>
            <a href="admin.html" class="nav-item">
                <span class="icon">âš™ï¸</span>
                <span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
            </a>
        </div>
    </nav>

    <!-- News Detail Modal -->
    <div class="modal-overlay" id="newsModal" onclick="closeNewsModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeNewsModal()">&times;</button>
            <div id="modalNewsContent"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script src="js/supabase.js"></script>
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }

        // Force open link in external browser (Safari on iOS)
        function openExternal(url) {
            // Check if running as PWA on iOS
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isStandalone = window.navigator.standalone === true;

            if (isIOS && isStandalone) {
                // iOS PWA cannot open external links in Safari
                // The only solution is to copy the URL
                if (confirm('iOS Ù„Ø§ ÙŠØ³Ù…Ø­ Ø¨ÙØªØ­ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙÙŠ Safari Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·ØŸ')) {
                    navigator.clipboard.writeText(url).then(() => {
                        alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·! âœ“\n\nØ§ÙØªØ­ Safari ÙˆØ§Ù„ØµÙ‚ Ø§Ù„Ø±Ø§Ø¨Ø·');
                    }).catch(() => {
                        // Fallback for clipboard API failure
                        prompt('Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·:', url);
                    });
                }
            } else {
                // For non-PWA or Android, use window.open
                window.open(url, '_blank', 'noopener,noreferrer');
            }
        }

        // Load news on page load
        document.addEventListener('DOMContentLoaded', loadNews);

        async function loadNews() {
            const grid = document.getElementById('newsGrid');
            const loading = document.getElementById('loadingState');
            const empty = document.getElementById('emptyState');

            try {
                const news = await getNews();
                loading.style.display = 'none';

                if (news.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                grid.innerHTML = news.map(item => createNewsCard(item)).join('');
            } catch (error) {
                loading.style.display = 'none';
                grid.innerHTML = `
          <div class="empty-state">
            <div class="icon">âš ï¸</div>
            <h3>Ø­Ø¯Ø« Ø®Ø·Ø£</h3>
            <p>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹</p>
          </div>
        `;
            }
        }

        function createNewsCard(item) {
            const date = new Date(item.created_at);
            const formattedDate = date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Escape JSON for onclick
            const itemData = encodeURIComponent(JSON.stringify(item));

            return `
        <article class="news-card" onclick="openNewsDetail('${itemData}')" style="cursor: pointer;">
          ${item.image_url ? `<img src="${item.image_url}" alt="${item.title}" class="news-image">` : ''}
          <h3>${item.title}</h3>
          <p class="news-preview">${(item.content || '').substring(0, 100)}${item.content && item.content.length > 100 ? '...' : ''}</p>
          <div class="news-date">
            <span>ğŸ“…</span>
            <span>${formattedDate}</span>
          </div>
          <div class="news-tap-hint">Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</div>
        </article>
      `;
        }

        // Store current news item for modal
        let currentNewsItem = null;

        function openNewsDetail(itemData) {
            const item = JSON.parse(decodeURIComponent(itemData));
            currentNewsItem = item;

            const date = new Date(item.created_at);
            const formattedDate = date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const modalContent = document.getElementById('modalNewsContent');
            modalContent.innerHTML = `
                ${item.image_url ? `<img src="${item.image_url}" alt="${item.title}" class="modal-news-image">` : ''}
                <h2 class="modal-news-title">${item.title}</h2>
                <div class="modal-news-date">
                    <span>ğŸ“…</span>
                    <span>${formattedDate}</span>
                </div>
                <div class="modal-news-content">${item.content || ''}</div>
                ${item.url ? `
                    <button onclick="openExternal('${item.url}')" class="btn btn-primary" style="margin-top: 1.5rem; width: 100%;">
                        <span>ğŸ“‹</span>
                        <span>Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</span>
                    </button>
                ` : ''}
            `;

            document.getElementById('newsModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeNewsModal(event) {
            if (event && event.target !== document.getElementById('newsModal')) return;
            document.getElementById('newsModal').classList.remove('active');
            document.body.style.overflow = '';
            currentNewsItem = null;
        }
    </script>
</body>

</html>