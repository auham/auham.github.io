<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ - Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ù…Ø±ÙŠØ¨ÙŠØ·">
    <meta name="theme-color" content="#D4AF37">
    <meta name="robots" content="noindex, nofollow">

    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„Ù…Ø±ÙŠØ¨ÙŠØ·</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="stylesheet" href="css/style.css">

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- OneSignal Push Notifications -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function (OneSignal) {
            await OneSignal.init({
                appId: "33461894-4470-4dd2-b2c3-222591f4ca88"
            });
        });
    </script>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">Ù…</div>
            <div class="header-title">
                <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙˆØ§Ù„Ø£Ø®Ø¨Ø§Ø±</p>
            </div>
        </div>
    </header>

    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <form id="loginForm">
            <div class="form-group">
                <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <input type="email" id="email" required placeholder="admin@example.com">
            </div>
            <div class="form-group">
                <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <button type="submit" class="btn btn-primary btn-block">
                <span>Ø¯Ø®ÙˆÙ„</span>
            </button>
        </form>
        <p id="loginError" style="color: #dc3545; text-align: center; margin-top: 1rem; display: none;"></p>
    </div>

    <!-- Admin Container (hidden until login) -->
    <div class="admin-container" id="adminContainer" style="display: none;">
        <!-- Logout Button -->
        <div style="text-align: left; margin-bottom: 1rem;">
            <button class="btn btn-secondary" onclick="handleLogout()" style="padding: 0.5rem 1rem;">
                ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            </button>
        </div>

        <!-- Tabs -->
        <div class="admin-tabs">
            <button class="admin-tab active" onclick="switchTab('invitations')">ğŸ’’ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</button>
            <button class="admin-tab" onclick="switchTab('news')">ğŸ“° Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</button>
        </div>

        <!-- Invitations Section -->
        <section class="admin-section active" id="invitationsSection">
            <!-- Add Invitation Form -->
            <div class="admin-card">
                <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¯Ø¹ÙˆØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                <form id="invitationForm">
                    <div class="form-group">
                        <label for="groomName">Ø§Ø³Ù… Ø§Ù„Ø¹Ø±ÙŠØ³ *</label>
                        <input type="text" id="groomName" required placeholder="Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯ Ø§Ù„Ù…Ø±ÙŠØ¨ÙŠØ·">
                    </div>
                    <div class="form-group">
                        <label for="groomFather">Ø§Ø³Ù… ÙˆØ§Ù„Ø¯ Ø§Ù„Ø¹Ø±ÙŠØ³</label>
                        <input type="text" id="groomFather" placeholder="Ø£Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ù…Ø±ÙŠØ¨ÙŠØ·">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="weddingDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­ÙÙ„ *</label>
                            <input type="date" id="weddingDate" required>
                        </div>
                        <div class="form-group">
                            <label for="weddingTime">ÙˆÙ‚Øª Ø§Ù„Ø­ÙÙ„</label>
                            <input type="time" id="weddingTime">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="locationName">Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†</label>
                        <input type="text" id="locationName" placeholder="Ù‚Ø§Ø¹Ø© Ø§Ù„ÙØ±Ø­ - Ø§Ù„Ø±ÙŠØ§Ø¶">
                    </div>
                    <div class="form-group">
                        <label for="locationUrl">Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Google Maps)</label>
                        <input type="url" id="locationUrl" placeholder="https://maps.google.com/...">
                        <small style="color: var(--text-secondary); font-size: 0.8rem;">Ø§Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø®Ø±Ø§Ø¦Ø·
                            Ù‚ÙˆÙ‚Ù„</small>
                    </div>
                    <div class="form-group">
                        <label for="description">Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <textarea id="description" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù† Ø§Ù„Ø­ÙÙ„..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="imageUrl">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="url" id="imageUrl" placeholder="https://example.com/image.jpg">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <span>ğŸ’’</span>
                        <span>Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø¹ÙˆØ©</span>
                    </button>
                </form>
            </div>

            <!-- Invitations List -->
            <div class="admin-card">
                <h3>ğŸ“‹ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                <div class="admin-list" id="invitationsList">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- News Section -->
        <section class="admin-section" id="newsSection">
            <!-- Add News Form -->
            <div class="admin-card">
                <h3>â• Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯</h3>
                <form id="newsForm">
                    <div class="form-group">
                        <label for="newsTitle">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø± *</label>
                        <input type="text" id="newsTitle" required placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø±">
                    </div>
                    <div class="form-group">
                        <label for="newsContent">Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
                        <textarea id="newsContent" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¨Ø±..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newsImageUrl">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="url" id="newsImageUrl" placeholder="https://example.com/image.jpg">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <span>ğŸ“°</span>
                        <span>Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¨Ø±</span>
                    </button>
                </form>
            </div>

            <!-- News List -->
            <div class="admin-card">
                <h3>ğŸ“‹ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                <div class="admin-list" id="newsList">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="nav-container">
            <a href="index.html" class="nav-item">
                <span class="icon">ğŸ’’</span>
                <span>Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</span>
            </a>
            <a href="news.html" class="nav-item">
                <span class="icon">ğŸ“°</span>
                <span>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</span>
            </a>
            <a href="admin.html" class="nav-item active">
                <span class="icon">âš™ï¸</span>
                <span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
            </a>
        </div>
    </nav>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script src="js/supabase.js"></script>
    <script>
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', checkAuth);

        async function checkAuth() {
            const session = await getSession();
            if (session) {
                showAdminPanel();
                loadAdminData();
            }
        }

        function showAdminPanel() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
        }

        function showLoginForm() {
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('adminContainer').style.display = 'none';
        }

        // Login Form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('loginError');

            try {
                await signIn(email, password);
                errorEl.style.display = 'none';
                showAdminPanel();
                loadAdminData();
                showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
            } catch (error) {
                console.error('Login error:', error);
                // Show the actual error message from Supabase
                let errorMessage = 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                if (error.message) {
                    if (error.message.includes('Invalid login credentials')) {
                        errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                    } else if (error.message.includes('Email not confirmed')) {
                        errorMessage = 'ÙŠØ±Ø¬Ù‰ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£ÙˆÙ„Ø§Ù‹';
                    } else if (error.message.includes('User not found')) {
                        errorMessage = 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
                    } else {
                        errorMessage = error.message;
                    }
                }
                errorEl.textContent = errorMessage;
                errorEl.style.display = 'block';
            }
        });

        async function handleLogout() {
            await signOut();
            showLoginForm();
            showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'success');
        }

        // Tab Switching
        function switchTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));

            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}Section`).classList.add('active');
        }

        // Load Admin Data
        async function loadAdminData() {
            loadInvitationsList();
            loadNewsList();
        }

        // Invitations
        async function loadInvitationsList() {
            const list = document.getElementById('invitationsList');
            try {
                const invitations = await getInvitations();
                if (invitations.length === 0) {
                    list.innerHTML = '<div class="empty-state"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø¹ÙˆØ§Øª</p></div>';
                    return;
                }
                list.innerHTML = invitations.map(inv => `
          <div class="admin-list-item">
            <div class="item-info">
              <h4>${inv.groom_name}</h4>
              <p>ğŸ“… ${new Date(inv.wedding_date).toLocaleDateString('ar-SA')}</p>
            </div>
            <div class="item-actions">
              <button class="btn-icon delete" onclick="handleDeleteInvitation('${inv.id}')" title="Ø­Ø°Ù">
                ğŸ—‘ï¸
              </button>
            </div>
          </div>
        `).join('');
            } catch (error) {
                list.innerHTML = '<div class="empty-state"><p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p></div>';
            }
        }

        document.getElementById('invitationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const invitation = {
                groom_name: document.getElementById('groomName').value,
                groom_father: document.getElementById('groomFather').value || null,
                wedding_date: document.getElementById('weddingDate').value,
                wedding_time: document.getElementById('weddingTime').value || null,
                location_name: document.getElementById('locationName').value || null,
                location_url: document.getElementById('locationUrl').value || null,
                description: document.getElementById('description').value || null,
                image_url: document.getElementById('imageUrl').value || null
            };

            try {
                await createInvitation(invitation);
                e.target.reset();
                loadInvitationsList();
                showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø¹ÙˆØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
            } catch (error) {
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ© âŒ', 'error');
            }
        });

        async function handleDeleteInvitation(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø¹ÙˆØ©ØŸ')) return;

            try {
                await deleteInvitation(id);
                loadInvitationsList();
                showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯Ø¹ÙˆØ© âœ…', 'success');
            } catch (error) {
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù âŒ', 'error');
            }
        }

        // News
        async function loadNewsList() {
            const list = document.getElementById('newsList');
            try {
                const news = await getNews();
                if (news.length === 0) {
                    list.innerHTML = '<div class="empty-state"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø±</p></div>';
                    return;
                }
                list.innerHTML = news.map(item => `
          <div class="admin-list-item">
            <div class="item-info">
              <h4>${item.title}</h4>
              <p>ğŸ“… ${new Date(item.created_at).toLocaleDateString('ar-SA')}</p>
            </div>
            <div class="item-actions">
              <button class="btn-icon delete" onclick="handleDeleteNews('${item.id}')" title="Ø­Ø°Ù">
                ğŸ—‘ï¸
              </button>
            </div>
          </div>
        `).join('');
            } catch (error) {
                list.innerHTML = '<div class="empty-state"><p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p></div>';
            }
        }

        document.getElementById('newsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const newsItem = {
                title: document.getElementById('newsTitle').value,
                content: document.getElementById('newsContent').value || null,
                image_url: document.getElementById('newsImageUrl').value || null
            };

            try {
                await createNews(newsItem);
                e.target.reset();
                loadNewsList();

                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±ÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                await sendNewsNotification(newsItem.title);

                showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¨Ø± Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
            } catch (error) {
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ© âŒ', 'error');
            }
        });

        // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
        async function sendNewsNotification(newsTitle) {
            try {
                const response = await fetch('https://onesignal.com/api/v1/notifications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Basic os_v2_app_gndbrfceobg5fmwdeiszd5gkrddrb5ebr47e7deqpfygkjrtteav7cxshnmgax7p2pspzd73iczxpy4phg5y7zqzepiskv4h2dprd5a'
                    },
                    body: JSON.stringify({
                        app_id: '33461894-4470-4dd2-b2c3-222591f4ca88',
                        included_segments: ['All'],
                        headings: { ar: 'ğŸ“° Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯', en: 'New News' },
                        contents: { ar: newsTitle, en: newsTitle },
                        url: 'https://auham.github.io/news.html',
                        chrome_web_icon: 'https://auham.github.io/icons/icon-192.png'
                    })
                });

                const result = await response.json();
                console.log('Notification sent:', result);
                return response.ok;
            } catch (error) {
                console.error('Failed to send notification:', error);
                return false;
            }
        }

        async function handleDeleteNews(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø®Ø¨Ø±ØŸ')) return;

            try {
                await deleteNews(id);
                loadNewsList();
                showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø®Ø¨Ø± âœ…', 'success');
            } catch (error) {
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù âŒ', 'error');
            }
        }



        // Toast
        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.className = 'toast', 3000);
        }
    </script>
</body>

</html>